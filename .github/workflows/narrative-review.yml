name: Narrative Chapter Review (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "02_NARRATIVE/book_01/CHAPTERS/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  narrative-review:
    runs-on: ubuntu-latest
    env:
      MODEL: gpt-5-mini
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect files
        id: collect
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE" "$HEAD" -- "02_NARRATIVE/book_01/CHAPTERS/**" || true)
          if [ -z "$CHANGED" ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "has_files=true" >> "$GITHUB_OUTPUT"
          echo "$CHANGED" > /tmp/files.txt

      - name: Run AI review
        if: steps.collect.outputs.has_files == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          COMMENT="/tmp/review.md"
          echo "<!-- NARRATIVE_REVIEW -->" > "$COMMENT"
          echo "# Narrative Review (AI)" >> "$COMMENT"
          echo "Model: $MODEL" >> "$COMMENT"
          echo "" >> "$COMMENT"
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            TEXT=$(cat "$FILE" | head -c 10000)
            PROMPT="Reviewe diesen deutschen YA-Fantasy Text kurz: $TEXT"
            
            RESP=$(curl -sS https://api.openai.com/v1/chat/completions \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg m "$MODEL" --arg p "$PROMPT" '{model:$m,messages:[{role:"user",content:$p}],max_tokens:1000}')")
            
            OUT=$(echo "$RESP" | jq -r '.choices[0].message.content // .error.message // "Error"')
            echo "## $FILE" >> "$COMMENT"
            echo "$OUT" >> "$COMMENT"
            echo "" >> "$COMMENT"
          done < /tmp/files.txt
          
          cat "$COMMENT"
          echo "COMMENT_BODY<<EOF" >> $GITHUB_ENV
          cat "$COMMENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post comment
        if: steps.collect.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          FILE=".tmp_narrative_review/review_comment.md"
          if [ ! -f "$FILE" ]; then exit 0; fi
          BODY=$(cat "$FILE")
          EXISTING=$(gh api "repos/$REPO/issues/$PR/comments" --paginate | jq -r '.[] | select(.body | contains("<!-- NARRATIVE_REVIEW -->")) | .id' | head -1 || true)
          if [ -n "$EXISTING" ]; then
            gh api -X PATCH "repos/$REPO/issues/comments/$EXISTING" -f body="$BODY"
          else
            gh api -X POST "repos/$REPO/issues/$PR/comments" -f body="$BODY"
          fi
      
        uses: actions/github-script@v7
        with:
          script: |
            const body = process.env.COMMENT_BODY;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body.includes('<!-- NARRATIVE_REVIEW -->'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

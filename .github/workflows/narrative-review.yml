name: Narrative Chapter Review (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, labeled, unlabeled]
    paths:
      - "02_NARRATIVE/book_01/CHAPTERS/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: narrative-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  MODEL_DEFAULT: gpt-5-mini
  MODEL_DEEP: gpt-5.2
  DEEP_LABEL: deep-review
  TOKEN_LIMIT: "4000"
  TARGET_CHUNK_TOKENS: "3500"
  TARGET_BATCH_TOKENS: "7000"
  MAX_OUTPUT_TOKENS: "1400"
  TEMPERATURE: "0.15"

jobs:
  narrative-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select model
        id: model
        run: |
          MODEL="${{ env.MODEL_DEFAULT }}"
          echo "model=$MODEL" >> "$GITHUB_OUTPUT"

      - name: Collect files
        id: collect
        env:
          TOKEN_LIMIT: ${{ env.TOKEN_LIMIT }}
          TARGET_CHUNK_TOKENS: ${{ env.TARGET_CHUNK_TOKENS }}
          TARGET_BATCH_TOKENS: ${{ env.TARGET_BATCH_TOKENS }}
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE" "$HEAD" -- "02_NARRATIVE/book_01/CHAPTERS/**" || true)
          if [ -z "$CHANGED" ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "has_files=true" >> "$GITHUB_OUTPUT"
          mkdir -p .tmp_narrative_review
          echo "$CHANGED" > .tmp_narrative_review/files.txt
          python3 .github/scripts/chunk_chapters.py

      - name: Run AI review
        if: steps.collect.outputs.has_files == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL: ${{ steps.model.outputs.model }}
        run: |
          COMMENT=".tmp_narrative_review/review_comment.md"
          echo "<!-- NARRATIVE_REVIEW -->" > "$COMMENT"
          echo "# Narrative Review (AI)" >> "$COMMENT"
          echo "- Model: ${MODEL}" >> "$COMMENT"
          echo "- PR: #${{ github.event.pull_request.number }}" >> "$COMMENT"
          echo "" >> "$COMMENT"
          BATCH_COUNT=$(jq 'length' .tmp_narrative_review/batches.json)
          for idx in $(seq 0 $((BATCH_COUNT-1))); do
            FILE=$(jq -r ".[$idx].file" .tmp_narrative_review/batches.json)
            TEXT=""
            CHUNK_COUNT=$(jq -r ".[$idx].chunks | length" .tmp_narrative_review/batches.json)
            for cidx in $(seq 0 $((CHUNK_COUNT-1))); do
              CPATH=$(jq -r ".[$idx].chunks[$cidx].chunk_path" .tmp_narrative_review/batches.json)
              CTEXT=$(cat "$CPATH")
              TEXT="${TEXT} ${CTEXT}"
            done
            PROMPT="Reviewe diesen Text: ${TEXT}"
            PAYLOAD=$(jq -n --arg m "$MODEL" --arg p "$PROMPT" '{model:$m,messages:[{role:"user",content:$p}],temperature:0.15,max_tokens:1400}')
            RESP=$(curl -sS -w "HTTP_CODE:%{http_code}" -H "Authorization: Bearer $OPENAI_API_KEY" -H "Content-Type: application/json" https://api.openai.com/v1/chat/completions -d "$PAYLOAD")
            HTTP_CODE=$(echo "$RESP" | grep -oP 'HTTP_CODE:\K[0-9]+')
            BODY=$(echo "$RESP" | sed 's/HTTP_CODE:[0-9]*$//')
            if [ "$HTTP_CODE" -ge 400 ]; then
              echo "## ${FILE}" >> "$COMMENT"
              echo "Error: HTTP ${HTTP_CODE}" >> "$COMMENT"
              continue
            fi
            OUT=$(echo "$BODY" | jq -r '.choices[0].message.content // "No output"')
            echo "## ${FILE}" >> "$COMMENT"
            echo "$OUT" >> "$COMMENT"
          done

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: narrative-review
          path: .tmp_narrative_review/
          if-no-files-found: ignore

      - name: Post comment
        if: steps.collect.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          FILE=".tmp_narrative_review/review_comment.md"
          if [ ! -f "$FILE" ]; then exit 0; fi
          BODY=$(cat "$FILE")
          EXISTING=$(gh api "repos/$REPO/issues/$PR/comments" --paginate | jq -r '.[] | select(.body | contains("<!-- NARRATIVE_REVIEW -->")) | .id' | head -1 || true)
          if [ -n "$EXISTING" ]; then
            gh api -X PATCH "repos/$REPO/issues/comments/$EXISTING" -f body="$BODY"
          else
            gh api -X POST "repos/$REPO/issues/$PR/comments" -f body="$BODY"
          fi
      
